<div class="entry-content">
<p>昨夏にスマートリモコン化したエアコンの改良版です。<br/>
<iframe class="embed-card embed-blogcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fs51517765.hatenadiary.jp%2Fentry%2F2018%2F07%2F15%2F144349" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;" title="エアコン（のリモコン）をフィジカルハックしてラズパイとSlackでスマートリモコン化する - プログラミング素人のはてなブログ"></iframe><cite class="hatena-citation"><a href="https://s51517765.hatenadiary.jp/entry/2018/07/15/144349">s51517765.hatenadiary.jp</a></cite></p><p>昨年のプロダクトの課題は、ボタンが一種類しか動作できないため、柔軟性がなかったことです。<br/>
今年は、リモコンのボタンを「電源off/on」「温度設定up」「温度設定down」を使えるようにしました。</p><p></p><h3>回路</h3>まずは回路です。昨年は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B8%A5%B9%A5%BF">トランジスタ</a>をつかったためうまくいきませんでした。<br/>
今年は、フォトカプラを使うことで複数のボタンが制御可能になりました。<br/>
<span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20190616154031p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20190616/20190616154031.png" title="f:id:s51517765:20190616154031p:plain"/></span><p>フォトカプラとは、得られる機能としては<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B8%A5%B9%A5%BF">トランジスタ</a>(NPN)にとても似ていますが、制御入力と制御出力が電気的に絶縁されている、ということが大きく異なります。<br/>
今回もいつもおなじみSODIALのパーツを使用しました。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Amazon">Amazon</a>で入手出来て安くてよいです。</p><div class="hatena-asin-detail"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/B01EZGT1H2/shirotoakb-22/"><img alt="フォトカプラ，SODIAL(R) 10ｘPCBボード　スルーホール　PC817C PC817 EL817 817CフォトカプラのDIP-4" class="hatena-asin-detail-image" src="https://d.hatena.ne.jp/images/hatena_aws.gif" title="フォトカプラ，SODIAL(R) 10ｘPCBボード　スルーホール　PC817C PC817 EL817 817CフォトカプラのDIP-4"/></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/B01EZGT1H2/shirotoakb-22/">フォトカプラ，SODIAL(R) 10ｘPCBボード　スルーホール　PC817C PC817 EL817 817CフォトカプラのDIP-4</a></p><ul><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> SODIAL</li><li><span class="hatena-asin-detail-label">メディア:</span> その他</li><li><a href="http://d.hatena.ne.jp/asin/B01EZGT1H2/shirotoakb-22" target="_blank">この商品を含むブログを見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div><p>ただしDataSheetが見つけられません。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Amazon">Amazon</a>のレヴューを参考に<a class="keyword" href="http://d.hatena.ne.jp/keyword/SHARP">SHARP</a>の似た品名のものを参考にしました。<br/>
DataSheetは秋月の商品サイトが便利で、たまにしか買わないのにお世話になっております…<br/>
<a href="https://akizukidenshi.com/download/PC817C.pdf">https://akizukidenshi.com/download/PC817C.pdf</a></p><p><figure class="figure-image figure-image-fotolife" title="PC817 SHARP"><span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20190616154710p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20190616/20190616154710.png" title="f:id:s51517765:20190616154710p:plain"/></span><figcaption>PC817 <a class="keyword" href="http://d.hatena.ne.jp/keyword/SHARP">SHARP</a></figcaption></figure></p><p>このような足のたくさんある部品は、○印があるところが1番pinで通常は千鳥ではなく周回するようにpinの番号になっています。だいたいの部品がそうなっているはずです。<br/>
<span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20190616155011p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20190616/20190616155011.png" title="f:id:s51517765:20190616155011p:plain"/></span></p><p>フォトカプラとは、回路図にあるようにLEDとフォトセンサを組み合わせたものです。<br/>
信号入力側はこのLEDのために入力電圧を制限する必要があります。<br/>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SHARP">SHARP</a>のものと同等であるとすれば、IFは20mAなのでラズパイの3.3Vで動作させるなら、165Ω以上の抵抗を入れる必要があります。<br/>
私は手元にたくさんあった500Ωにしました。（一般には15%ぐらいのマージンを取って200Ωぐらいでよいです。）<figure class="figure-image figure-image-fotolife" title="SHARP PC817C Datasheet "><span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20190616155902p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20190616/20190616155902.png" title="f:id:s51517765:20190616155902p:plain"/></span><figcaption><a class="keyword" href="http://d.hatena.ne.jp/keyword/SHARP">SHARP</a> PC817C Datasheet </figcaption></figure></p><p>その他は昨年のものと同じ要領です。<br/>
<span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20190616163117j:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20190616/20190616163117.jpg" title="f:id:s51517765:20190616163117j:plain"/></span><br/>
</p><h3>プログラム</h3>昨年からの変更点は、リアルタイムで動作させる機能を追加しました。<br/>
「now」や「今」といったキーワードで動作させます。
<pre class="code lang-python" data-lang="python" data-unlink=""><span class="synPreProc">@</span><span class="synIdentifier">listen_to</span>(<span class="synConstant">u'(now|今|すぐ)+'</span>)
<span class="synPreProc">@</span><span class="synIdentifier">respond_to</span>(<span class="synConstant">u'(now|今|すぐ)+'</span>)
<span class="synStatement">def</span> <span class="synIdentifier">timerReset</span>(message, something):
    <span class="synStatement">try</span>:
        text = message.body[<span class="synConstant">'text'</span>]
        <span class="synStatement">if</span> <span class="synConstant">"on"</span> <span class="synStatement">in</span> text <span class="synStatement">or</span> <span class="synConstant">"off"</span> <span class="synStatement">in</span> text <span class="synStatement">or</span> <span class="synConstant">"power"</span> <span class="synStatement">in</span> text:
            airconSet.aircon_power()
            message.reply(<span class="synConstant">"電源を操作しました。"</span>)
        <span class="synStatement">elif</span> <span class="synConstant">"up"</span> <span class="synStatement">in</span> text <span class="synStatement">or</span> <span class="synConstant">"上"</span> <span class="synStatement">in</span> text:
            airconSet.aircon_temp_set_up(<span class="synConstant">1</span>)
            message.reply(<span class="synConstant">"温度設定を +1 しました。"</span>)
        <span class="synStatement">elif</span> <span class="synConstant">"down"</span> <span class="synStatement">in</span> text <span class="synStatement">or</span> <span class="synConstant">"下"</span> <span class="synStatement">in</span> text:
            airconSet.aircon_temp_set_down(<span class="synConstant">1</span>)
            message.reply(<span class="synConstant">"温度設定を -1 しました。"</span>)
    <span class="synStatement">except</span> <span class="synType">Exception</span> <span class="synStatement">as</span> e:
        <span class="synIdentifier">print</span>(e)
        message.reply(<span class="synConstant">"指示を解釈できませんでした。"</span>)
</pre><p>このとき「now up」とすると、スケジュール機能も同時に動作してしまうので、こちらも変更しました。<br/>
数字が入っているときはスケジュールとして認識させたいので起動条件を変更しました。<br/>
「up」or「down」と数字が入っているときはこちらが起動します。<code>\s?</code>がスペース（省略可能）で<code>\d</code>が整数を表す<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C0%B5%B5%AC%C9%BD%B8%BD">正規表現</a>です。</p>
<pre class="code lang-python" data-lang="python" data-unlink=""><span class="synPreProc">@</span><span class="synIdentifier">listen_to</span>(<span class="synConstant">u'(上|up|下|down)\s?\d'</span>)  <span class="synComment"># up +スペース+数字 スペースは省略可能</span>
<span class="synPreProc">@</span><span class="synIdentifier">respond_to</span>(<span class="synConstant">u'(上|up|下|down)\s?\d'</span>)
<span class="synStatement">def</span> <span class="synIdentifier">OrderUpDown</span>(message, something):
　　----
</pre><p></p><h3>まとめ</h3>フォトカプラを使ってリモコン（エアコン）ハックを高機能化しました。<br/>
最初からフォトカプラに気づいていれば…というところではありますが。<br/>
<span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20190616163708p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20190616/20190616163708.png" title="f:id:s51517765:20190616163708p:plain"/></span><br/>
<iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fs51517765%2FAirconPi" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="s51517765/AirconPi"></iframe><cite class="hatena-citation"><a href="https://github.com/s51517765/AirconPi">github.com</a></cite><br/>
<div class="hatena-asin-detail"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/B00M0O6KOE/shirotoakb-22/"><img alt="国内外 各メーカー共通1000種対応 エアコン用ユニバーサルマルチリモコン　自動検索機能搭載" class="hatena-asin-detail-image" src="https://images-fe.ssl-images-amazon.com/images/I/41xzYqQby5L._SL160_.jpg" title="国内外 各メーカー共通1000種対応 エアコン用ユニバーサルマルチリモコン　自動検索機能搭載"/></a><div class="hatena-asin-detail-info"><p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/B00M0O6KOE/shirotoakb-22/">国内外 各メーカー共通1000種対応 エアコン用ユニバーサルマルチリモコン　自動検索機能搭載</a></p><ul><li><span class="hatena-asin-detail-label">出版社/メーカー:</span> ショップF</li><li><span class="hatena-asin-detail-label">メディア:</span> </li><li><a href="http://d.hatena.ne.jp/asin/B00M0O6KOE/shirotoakb-22" target="_blank">この商品を含むブログを見る</a></li></ul></div><div class="hatena-asin-detail-foot"></div></div><p></p><h3>参考</h3><iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fsukesuke%2Fitems%2F1ac92251def87357fdf6" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="PythonのslackbotライブラリでSlackボットを作る - Qiita"></iframe><cite class="hatena-citation"><a href="https://qiita.com/sukesuke/items/1ac92251def87357fdf6">qiita.com</a></cite>
</div>