<div class="entry-content">
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Python">Python</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>を使って<a class="keyword" href="http://d.hatena.ne.jp/keyword/Tweet">Tweet</a>をしようとしたとき、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>が「投稿できない」という意味の<code>status code 186</code>を返してくることがあります。</p>
<pre class="code" data-lang="" data-unlink="">[{'code': 186, 'message': 'Tweet needs to be a bit shorter.'}]</pre><p>これは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Tweet">Tweet</a>の文字数制限に対してOverしている、というErrorです。</p><p>ところで、2017年に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Tweet">Tweet</a>できる文字数が変更になりました。<br/>
<a href="https://blog.brkr.jp/twitter-2018/">https://blog.brkr.jp/twitter-2018/</a><cite class="hatena-citation"><a href="https://blog.brkr.jp/twitter-2018/">blog.brkr.jp</a></cite></p>
<blockquote>
<p>さて、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>といえば「140文字」の上限があることで知られていますが、2017/11/7にこのルールが変更され、英語などの言語でツイートの上限が280文字になりました。ただし日本語・中国語・韓国語はこれまで通り140文字のままです。</p><p>というのも、英語などアルファベット系の文字を使う言語は日本語や中国語に比べて１つのツイートに含められる情報量が少なく、140文字の制限が大きなデメリットになっていたためだそうです。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>が一部ユーザーを対象に280文字を上限にするテストを行った結果、「<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>のスピードとシンプルさを保ちながら、より表現できるようにすることが達成できた」ので、各言語での制限拡大が始まったとのことです。</p>
</blockquote>
<p>基本的には、2バイト文字（日本語のひらがな、カタカナ、漢字など）は140文字、1バイト文字（アルファベット、数字など）は280文字まで投稿できるようです。</p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Tweet">Tweet</a>画面では、円グラフと10文字以下では数字であとどれぐらい記入できるか？が表示されています。</p><h3>実際に入力して確かめてみた</h3>・ひらがな 140文字
<pre class="code" data-lang="" data-unlink="">あいうえおかきくけこさしすせそたちつてとあいうえおかきくけこさしすせそたちつてとあいうえおかきくけこさしすせそたちつてとあいうえおかきくけこさしすせそたちつてとあいうえおかきくけこあいうえおかきくけこさしすせそたちつてとあいうえおかきくけこあいうえおかきくけこさしすせそたちつてと</pre><p><figure class="figure-image figure-image-fotolife" title="ひらがな"><span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20200118181846p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20200118/20200118181846.png" title="f:id:s51517765:20200118181846p:plain"/></span><figcaption>ひらがな</figcaption></figure>・アルファベット 280文字</p>
<pre class="code" data-lang="" data-unlink="">ABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRST</pre><p><figure class="figure-image figure-image-fotolife" title="アルファベット"><span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20200118182413p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20200118/20200118182413.png" title="f:id:s51517765:20200118182413p:plain"/></span><figcaption>アルファベット</figcaption></figure>・大文字でも小文字でもアルファベットは280文字</p>
<pre class="code" data-lang="" data-unlink="">abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrst</pre><p><figure class="figure-image figure-image-fotolife" title="アルファベット小文字"><span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20200118182558p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20200118/20200118182558.png" title="f:id:s51517765:20200118182558p:plain"/></span><figcaption>アルファベット小文字</figcaption></figure>・数字 280文字</p>
<pre class="code" data-lang="" data-unlink="">1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890</pre><p><figure class="figure-image figure-image-fotolife" title="数字"><span itemscope="" itemtype="http://schema.org/Photograph"><img alt="f:id:s51517765:20200118182737p:plain" class="hatena-fotolife" itemprop="image" src="https://cdn-ak.f.st-hatena.com/images/fotolife/s/s51517765/20200118/20200118182737.png" title="f:id:s51517765:20200118182737p:plain"/></span><figcaption>数字</figcaption></figure></p><p>このほかに、改行は0.5文字となっています。<code>\n</code>で 0.5文字ということのようです。</p><p></p><h3><a class="keyword" href="http://d.hatena.ne.jp/keyword/Python">Python</a>で文字列の長さを調整する</h3>本題ですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Python">Python</a>で投稿するときには<a class="keyword" href="http://d.hatena.ne.jp/keyword/Tweet">Tweet</a>画面のような円グラフがあるわけではないので文字列の長さでカウントしていました。<br/>
<code>len(text)</code>ではひらがなでもアルファベットでもどちらも同じ１文字とカウントされます。
<pre class="code lang-python" data-lang="python" data-unlink=""><span class="synIdentifier">print</span>(<span class="synIdentifier">len</span>(<span class="synConstant">"あいうえお"</span>))
&gt;&gt;<span class="synConstant">5</span>
<span class="synIdentifier">print</span>(<span class="synIdentifier">len</span>(<span class="synConstant">"abcde"</span>)
&gt;&gt;<span class="synConstant">5</span>
</pre><p>つまり、ひらがなやカタカナ、漢字であれば140文字にしなければならないのに、アルファベットや数字は280文字まで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Tweet">Tweet</a>できて、<code>len(text)</code>では厳密にカウントすることが出来ません。<br/>
こうなると、合わせて140文字以下となるようにするしかありませんでした。</p><p></p><h3><a class="keyword" href="http://d.hatena.ne.jp/keyword/twitter">twitter</a>-text-perserを使ってみる</h3><a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>の文字数をカウントする<a class="keyword" href="http://d.hatena.ne.jp/keyword/Python">Python</a>ライブラリがありました。<br/>
<iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fswen128%2Ftwitter-text-python" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="swen128/twitter-text-python"></iframe><cite class="hatena-citation"><a href="https://github.com/swen128/twitter-text-python">github.com</a></cite><p>ですが、注意が必要なのが似た名前の異なるライブラリ&lt; ttps://<a class="keyword" href="http://d.hatena.ne.jp/keyword/github">github</a>.com/edmondburnett/<a class="keyword" href="http://d.hatena.ne.jp/keyword/twitter">twitter</a>-text-<a class="keyword" href="http://d.hatena.ne.jp/keyword/python">python</a> &gt; があります。（リンクは敢えて無効にしておきます）<br/>
上記、<a class="keyword" href="http://d.hatena.ne.jp/keyword/twitter">twitter</a>-text-parserの開発者も仕様を満たしていない、とコメントされています。<br/>
なぜか検索で、こちらが出てくることがあります。</p><p>ですので、間違えずに<a class="keyword" href="http://d.hatena.ne.jp/keyword/twitter">twitter</a>-text-parserを<a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>に従って、pipでインストールします。が…</p>
<pre class="code" data-lang="" data-unlink="">$ pip install twitter-text-parser</pre><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>ではよく発生する<code>cp932</code>関連のErrorが出ます。<br/>
これは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%B8%BB%FA%A5%B3%A1%BC%A5%C9">文字コード</a>を<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>の標準である<code>Shift-Jis</code>で解釈しようとしてしまうことで発生するErrorです。</p>
<pre class="code" data-lang="" data-unlink="">    Complete output (5 lines):
    Traceback (most recent call last):
      File "&lt;string&gt;", line 1, in &lt;module&gt;
      File "C:\Users\****\AppData\Local\Temp\pip-install-7v9zby12\twitter-text-parser\setup.py", line 4, in &lt;module&gt;
        long_description = f.read()
    UnicodeDecodeError: 'cp932' codec can't decode byte 0x9e in position 1413: illegal multibyte sequence
    ----------------------------------------
ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.</pre><p><code>setup.py</code>のErrorの場所を↓のように<code>utf-8</code>を指定してあげる必要があります。</p>
<pre class="code" data-lang="" data-unlink="">with open("README.rst", "r",encoding="utf-8") as f:
    long_description = f.read()</pre><p>このように編集してpip installするために、ソースを<a class="keyword" href="http://d.hatena.ne.jp/keyword/Github">Github</a>もしくは<a class="keyword" href="http://d.hatena.ne.jp/keyword/pypi">pypi</a>からダウンロードし解凍、編集し再度Zipで圧縮します。<br/>
ローカルでのpip install は↓を参考にします。企業などのネットワークでpipがブロックされている場合にも使える方法です。<br/>
<iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Ftech-diary.net%2Fpython-library-offline-install%2F" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="【会社向け】オフラインでpip installしてプロキシ回避する方法｜テックダイアリー"></iframe><cite class="hatena-citation"><a href="https://tech-diary.net/python-library-offline-install/">tech-diary.net</a></cite><br/>
</p>
<pre class="code" data-lang="" data-unlink="">// ソースコードのあるフォルダにコマンドラインで移動
$ cd C:\Users\****\Desktop
// ローカルファイルからインストール
$ pip install --no-deps twitter-text-parser-1.0.0.zip</pre><p>インストールが出来てもまだErrorがでます。</p>
<pre class="code" data-lang="" data-unlink="">Traceback (most recent call last):
  File "C:/Users/*****/twitter_text_count.py", line 1, in &lt;module&gt;
    ?from twitter_text import parse_tweet
  File "C:\Users\*****\Anaconda3\lib\site-packages\twitter_text\__init__.py", line 1, in &lt;module&gt;
    from twitter_text.parse_tweet import parse_tweet, ParsedResult
  File "C:\Users\*****\Anaconda3\lib\site-packages\twitter_text\parse_tweet.py", line 5, in &lt;module&gt;
    import attr
ImportError: No module named 'attr'</pre><p>attrsというライブラリをインストールします。</p>
<pre class="code" data-lang="" data-unlink="">$ pip install attrs</pre><p>これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>が動くようになりました。</p>
<pre class="code lang-python" data-lang="python" data-unlink=""><span class="synPreProc">from</span> twitter_text <span class="synPreProc">import</span> parse_tweet
<span class="synComment"># OKとなる例</span>
text=<span class="synConstant">"ABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRST"</span>
<span class="synIdentifier">print</span>(parse_tweet(text))
&gt;&gt;ParsedResult(valid=<span class="synIdentifier">True</span>, weightedLength=<span class="synConstant">280</span>, permillage=<span class="synConstant">1000</span>, validRangeStart=<span class="synConstant">0</span>, validRangeEnd=<span class="synConstant">279</span>, displayRangeStart=<span class="synConstant">0</span>, displayRangeEnd=<span class="synConstant">279</span>)
|
<span class="synComment"># NGとなる例（1文字増やした）</span>
text=<span class="synConstant">"ABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTU"</span>
<span class="synIdentifier">print</span>(parse_tweet(text))
&gt;&gt;ParsedResult(valid=<span class="synIdentifier">False</span>, weightedLength=<span class="synConstant">281</span>, permillage=<span class="synConstant">1003</span>, validRangeStart=<span class="synConstant">0</span>, validRangeEnd=<span class="synConstant">279</span>, displayRangeStart=<span class="synConstant">0</span>, displayRangeEnd=<span class="synConstant">280</span>)
</pre><p></p><h3>参考</h3><iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2FYuu94%2Fitems%2F9ffdfcb2c26d6b33792e" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="WindowsでCP932(Shift-JIS)エンコード以外のファイルを開くのに苦労した話 - Qiita"></iframe><cite class="hatena-citation"><a href="https://qiita.com/Yuu94/items/9ffdfcb2c26d6b33792e">qiita.com</a></cite><br/>
<iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2FPND%2Fitems%2F17e87b8839c9099d2e70" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="ツイートの文字数を **厳密に** 数える方法 - Qiita"></iframe><cite class="hatena-citation"><a href="https://qiita.com/PND/items/17e87b8839c9099d2e70">qiita.com</a></cite><br/>
<iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fpypi.org%2Fproject%2Ftwitter-text-parser%2F" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="twitter-text-parser"></iframe><cite class="hatena-citation"><a href="https://pypi.org/project/twitter-text-parser/">pypi.org</a></cite><br/>
<iframe class="embed-card embed-webcard" frameborder="0" scrolling="no" src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.lifewithpython.com%2F2017%2F06%2Fpython-attrs.html" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;" title="ライブラリ： attrs "></iframe><cite class="hatena-citation"><a href="https://www.lifewithpython.com/2017/06/python-attrs.html">www.lifewithpython.com</a></cite>
</div>